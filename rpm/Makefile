# This file is part of tcollector.
# Copyright (C) 2011  The tcollector Authors.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License, or (at your
# option) any later version.  This program is distributed in the hope that it
# will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser
# General Public License for more details.  You should have received a copy
# of the GNU Lesser General Public License along with this program.  If not,
# see <http://www.gnu.org/licenses/>.

# This Makefile is a complete train wreck.  I'm sorry.  --tsuna

PACKAGE_VERSION := 1.3.3
RPM_REVISION := 1
# Where do we install our files.
tcollectordir := /usr/local/tcollector

# Various commands we need.
MKDIR_P := mkdir -p
CP_P := cp -p
# In some environment this command can be called `gsha1sum' or `digest'.
SHA1SUM := sha1sum
ZIP := zip -9
PYTHON_VERSION := 2.6
PYTHON := python$(PYTHON_VERSION)

# Our "source tree" is in the parent directory, always.
VPATH := ..

git_version := \
  `git rev-list --pretty=format:%h HEAD --max-count=1 | sed 1d || echo unknown`
git_fullsha1 := \
  `git rev-list --pretty=format:%H HEAD --max-count=1 | sed 1d || echo unknown`

# What / where do we build.
RPM_TARGET := noarch
BASENAME := tcollector-$(PACKAGE_VERSION)-$(RPM_REVISION)
RPM := $(BASENAME).$(RPM_TARGET).rpm
SRPM := $(BASENAME).src.rpm
COLLECTORSRPM := tcollector-collectors-$(PACKAGE_VERSION)-$(RPM_REVISION).$(RPM_TARGET).rpm
EOSRPM := tcollector-eos-$(PACKAGE_VERSION)-$(RPM_REVISION).$(RPM_TARGET).rpm
SWIX := $(BASENAME).swix

all: rpm swix

$(SWIX): manifest.txt $(EOSRPM) $(RPM) $(COLLECTORSRPM)
	$(ZIP) $@ $^

swix: $(SWIX)

manifest.txt: Makefile
	set -e; { \
          echo 'format: 1'; \
          echo 'primaryRpm: $(EOSRPM)'; \
	  for rpm in $(EOSRPM) $(RPM) $(COLLECTORSRPM); do \
            echo -n "$$rpm-sha1: "; \
            set `$(SHA1SUM) "$$rpm"`; \
            echo $$1; \
          done; \
        } >$@

rpm:
	set -e; { \
          echo "# File generated by Makefile, do not edit"; \
	  sed \
            -e 's/@PACKAGE_VERSION@/$(PACKAGE_VERSION)/' \
            -e 's/@PYTHON_VERSION@/$(PYTHON_VERSION)/' \
            -e "s/@GIT_SHORTSHA1@/$(git_version)/" \
            -e "s/@GIT_FULLSHA1@/$(git_fullsha1)/" \
            -e 's/@RPM_REVISION@/$(RPM_REVISION)/' \
	    tcollector.spec; \
        } >tcollector-t.spec
	rpmbuild --define "_topdir %(pwd)/" \
          --define "_sourcedir %(pwd)/dist/" \
          --define "_rpmdir %(pwd)" \
          --define "_srcrpmdir %{_topdir}" \
          -ba tcollector-t.spec
	if test -f $(RPM_TARGET)/$(RPM); then mv $(RPM_TARGET)/$(RPM) .; else mv tcollector.$(RPM_TARGET).rpm $(RPM); fi
	if test -f $(RPM_TARGET)/$(COLLECTORSRPM); then mv $(RPM_TARGET)/$(COLLECTORSRPM) .; else mv tcollector-collectors.$(RPM_TARGET).rpm $(COLLECTORSRPM); fi
	if test -f $(RPM_TARGET)/$(EOSRPM); then mv $(RPM_TARGET)/$(EOSRPM) .; else mv tcollector-eos.$(RPM_TARGET).rpm $(EOSRPM); fi

clean:
	rm -rf tcollector-t.spec manifest.txt bld dist tmp $(RPM_TARGET)

distclean: clean
	rm -f $(SWIX) $(RPM) $(SRPM) $(COLLECTORSRPM) $(EOSRPM)

.PHONY: all rpm clean distclean swix
.SUFFIXES: .spec .rpm
